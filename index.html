<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Furious Car</title>
        <link rel="icon" type="image/png"  href="" />
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
        <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
        <script src="opponent.js"></script>
        <script src="player.js"></script>
        <script src="roadMarking.js"></script>
    </head>

    <body>
    <div class="split left">
        <div id="first-sketch-container">
            <script>
                var gameSketch = function(sketch) {

                    var im_car_green;
                    var im_car_red;
                    var im_boom;
                    var im_heart;
                    var font;
                    var playerSpeed = 7;
                    var opponents = [];
                    var roadMarkings = [];
                    var score = 0;
                    var lives = 5;
                    var power = 0;


                    sketch.preload = function() {

                        im_car_green = sketch.loadImage('assets/Car_Green.png');
                        im_car_red = sketch.loadImage('assets/Car_Red.png');
                        im_boom = sketch.loadImage('assets/boom.png');
                        im_heart = sketch.loadImage('assets/heart.png');
                        font = sketch.loadFont('assets/8-bit.ttf');

                    };

                    //always put the paramater if you call p5 element
                    sketch.setup = function() {

                        const cnv = sketch.createCanvas(600, 600);
                        const x = (sketch.windowWidth/2 - sketch.width/2)/4;
                        const y = (sketch.windowHeight - sketch.height)/2;
                        cnv.position(x, y);

                        player = new Player(sketch, sketch.width, sketch.height, im_car_red);
                        roadMarkings.push(new RoadMarking(sketch, sketch.width, sketch.height, playerSpeed));
                        opponents.push(new Opponent(sketch, sketch.width, sketch.height, playerSpeed, im_car_green, im_boom));

                    };

                    sketch.draw = function() {

                        sketch.background(44, 44, 44);

                        // New road markings appear after certain number of frames
                        if (sketch.frameCount % 25 === 0) {
                            roadMarkings.push(new RoadMarking(sketch, sketch.width, sketch.height, playerSpeed));
                        }

                        // Show road markings
                        for (var i = roadMarkings.length-1 ; i >= 0 ; i--) {
                            roadMarkings[i].show();
                            roadMarkings[i].update();

                            // Remove road markings once the are off the screen
                            if (roadMarkings[i].offscreen()) {
                                roadMarkings.splice(i, 1);
                            }
                        }

                        //Upgrade speed
                        if (sketch.frameCount % 900 === 0) {
                            playerSpeed++;
                        }

                        // New opponents appear after certain number of frames
                        if (sketch.frameCount % 130 === 0) {
                            var nb = sketch.floor(sketch.random() * 3 + 1);

                            console.log(nb);
                            for(var i = 1; i <= nb; i++) {
                                opponents.push(new Opponent(sketch, sketch.width, sketch.height, playerSpeed, im_car_green, im_boom));
                            }
                        }

                        // Show opponents
                        for (var i = opponents.length-1 ; i >= 0 ; i--) {
                            opponents[i].show();
                            opponents[i].update();

                            if (opponents[i].overtakenBy(player) && opponents[i].isOvertakenBy === false) {
                                score += 5;
                                opponents[i].isOvertakenBy = true;
                                if (score % 30 === 0 && power < 5)
                                    power++;
                            }

                            // If opponents collide with the player, they get destroyed
                            if (opponents[i].hits(player)) {
                                opponents[i].boom();
                                opponents.splice(i, 1);

                                // Penalty for collision is -10, and you loose one life
                                score = (score >= 10)?(score-10):0;
                                lives--;
                            }
                            // Remove opponents once the are off the screen
                            else if (opponents[i].offscreen()) {
                                opponents.splice(i, 1);
                            }
                        }

                        // Show the player
                        player.show();

                        //Show the power
                        sketch.fill(20);
                        sketch.rect(sketch.width-450, sketch.height-50, 300, 20);


                        // Game controls
                        if (sketch.keyIsDown(sketch.LEFT_ARROW)) {
                            player.turnLeft();
                        }
                        if (sketch.keyIsDown(sketch.RIGHT_ARROW)) {
                            player.turnRight();
                        }


                        // Show player stats
                        sketch.textSize(40);
                        sketch.textFont(font);
                        sketch.textAlign(sketch.LEFT);
                        sketch.fill(255);
                        sketch.text('Score: ' + score, 30, 60);

                        for (var i = 0 ; i <= lives ; i++) {
                            sketch.image(im_heart, sketch.width - (i*70), sketch.height-580);
                        }

                        for (var i = 0; i < power ; i++) {
                            sketch.fill(102);
                            sketch.rect(150 + (i*60), sketch.height-50, 60, 20);
                        }

                        if (power === 5) {
                            power = 0;
                        }

                        // Check if game is over
                        if (lives === 0) {

                            sketch.textSize(60);
                            sketch.textFont(font);
                            sketch.textStyle(sketch.BOLD);
                            sketch.textAlign(sketch.CENTER);
                            sketch.fill(255);
                            sketch.text('GAME OVER', sketch.width/2, sketch.height/2);

                            noLoop();
                        }
                    }
                };
                new p5(gameSketch, 'first-sketch-container');
            </script>
        </div>
    </div>
    <div class="split right">
        <div id="second-sketch-container">
            <script>
                const videoSketch = function (sketch) {

                    // The video
                    let video;
                    // For displaying the label
                    let label = "waiting...";
                    // The classifier
                    let classifier;
                    let modelURL = 'https://storage.googleapis.com/tm-models/YadBJmj5/';

                    //change the color if clicked
                    sketch.preload = function () {

                        classifier = ml5.imageClassifier(modelURL + 'model.json');

                    };

                    sketch.setup = function () {

                        var cnv = sketch.createCanvas(640, 520);
                        var x = (sketch.windowWidth/2 - sketch.width)/2;
                        var y = (sketch.windowHeight - sketch.height)/2;
                        cnv.position(x, y);

                        // Create the video
                        video = sketch.createCapture(sketch.VIDEO);
                        video.hide();

                        // STEP 2: Start classifying
                        sketch.classifyVideo();

                    };

                    sketch.classifyVideo = function () {

                        classifier.classify(video, sketch.gotResults);

                    };

                    sketch.draw = function () {

                        sketch.background(0);

                        // Draw the video
                        sketch.image(video, 0, 0);

                        // STEP 4: Draw the label
                        sketch.textSize(32);
                        sketch.textAlign(sketch.CENTER, sketch.CENTER);
                        sketch.fill(255);
                        sketch.text(label, sketch.width / 2, sketch.height - 16);

                        // Pick an emoji, the "default" is train
                        let emoji = "ðŸš‚";
                        if (label === "Rainbow") {
                            emoji = "ðŸŒˆ";
                        } else if (label === "Unicorn") {
                            emoji = "ðŸ¦„";
                        } else if (label === "Ukulele") {
                            emoji = "ðŸŽ¸";
                        }

                        // Draw the emoji
                        sketch.textSize(256);
                        sketch.text(emoji, sketch.width / 2, sketch.height / 2);
                    };

                    sketch.gotResults = function (error, results) {

                        // Something went wrong!
                        if (error) {
                            console.error(error);
                            return;
                        }
                        // Store the label and classify again!
                        label = results[0].label;
                        sketch.classifyVideo();

                    }

                };
                new p5(videoSketch, 'second-sketch-container');
            </script>
        </div>
    </div>



    </body>
</html>
